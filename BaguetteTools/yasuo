if myHero.charName ~= "Yasuo" then return end

function OnLoad()
	Menu();
	Flash = nil;
	if myHero:GetSpellData(SUMMONER_1).name:lower():find("summonerflash") then 
		Flash = SUMMONER_1;
	elseif myHero:GetSpellData(SUMMONER_2).name:lower():find("summonerflash") then 
		Flash = SUMMONER_2;
	end
	Q = false;
	R = false;
	E = false;
	beyblade = false;
	FlashReady = false;
	havetoflash = false;
	enemyMinions = minionManager(MINION_ENEMY, 850, myHero, MINION_SORT_HEALTH_ASC);
	jungleMinions = minionManager(MINION_JUNGLE, 850, myHero, MINION_SORT_MAXHEALTH_DEC);
end

function OnTick()
	if myHero:CanUseSpell(_Q) == READY then
		Q = true;
	else
		Q = false;
	end
	if myHero:CanUseSpell(_R) == READY then
		R = true;
	else
		R = false;
	end
	if myHero:CanUseSpell(_E) == READY then
		E = true;
	else
		E = false;
	end
	Target = GetTarget();
	if myHero:GetSpellData(Flash).currentCd == 0 or myHero:CanUseSpell(Flash) == READY then
		FlashReady = true;
	else
		FlashReady = false;
	end
	if havetoflash and Target ~= nil then
		havetoflash = false;
		CastSpell(Flash, Target.x, Target.z);
		DelayAction(function() havetoflash = false; end)
	end
	DashCheck();
end

function GetTarget()
	local t = nil;
	if _G.AutoCarry and _G.AutoCarry.Keys and _G.Reborn_Loaded ~= nil then
		t = _G.AutoCarry.Crosshair:GetTarget();
	end
	if ValidTarget(t) and t.type == myHero.type then
		return t
	else
		return nil
	end
end

function OnUpdateBuff(unit, buff, stacks)
	if unit and unit.isMe then
		if buff.name:lower() == "yasuoq3w" then
			Q3 = true;
		end
	end
end

function OnRemoveBuff(unit, buff)
	if unit and unit.isMe then
		if buff.name:lower() == "yasuoq3w" then
			Q3 = false;
		end
	end
end

function DashCheck()
	if Q3 and Q and E and FlashReady and Target ~= nil and CanFlashQ3(Target) then
		enemyMinions:update();
		jungleMinions:update();
		for i, unit in pairs(enemyMinions.objects) do
			if GetDistanceSqr(Target, unit) < 180625 and GetDistanceSqr(unit) < 180625 then
				DelayAction(function()
					beyblade = true;
				end, 0.25);
				CastSpell(_E, unit);
			end
		end
		for i, unit in pairs(jungleMinions.objects) do
			if GetDistanceSqr(Target, unit) < 180625 and GetDistanceSqr(unit) < 180625 then
				DelayAction(function()
					beyblade = true;
				end, 0.25);
				CastSpell(_E, unit);
			end
		end
	end
end

function OnAnimation(unit, animation)
	if unit.isMe then
		if animation == "Spell3" then
			if beyblade == true and FlashReady and Target ~= nil and Q3 and Q then
				beyblade = false;
				CastSpell(_Q, myHero.x, myHero.z);
				havetoflash = true;
			end
		end
	end
end

function CanFlashQ3(unit)
	if unit ~= nil then
		if Param.Enable then
			if Param.key or (Param.QE and unit.health < q3Dmg(unit) + eDmg(unit) and EnemyInRange() == 1) or (Param.Auto and (CanHit(Param.HowMuch) and R)) then
				return true
			else
				return false
			end
		else
			return false
		end
	else
		return false
	end
end

function q3Dmg(unit)
	local l = myHero:GetSpellData(_Q).level;
	if l > 0 then
		local r = l * 20;
		local d_t = myHero.totalDamage + r;
		local crit = math.round(math.abs(myHero.critChance)*100);
		if crit == 100 then
			d_t = d_t * 1.9;
		end
		return math.floor(myHero:CalcDamage(unit, d_t))
	else
		return 0
	end
end

function eDmg(unit)
	local l = myHero:GetSpellData(_E).level;
	if l > 0 then
		local r = l * 20 + 50;
		local d_t = (myHero.ap * .6) + r;
		return math.floor(myHero:CalcMagicDamage(unit, d_t))
	else
		return 0
	end
end

function OnDraw()
	if Target ~= nil then
		local damages = q3Dmg(Target) + eDmg(Target);
		if damages > Target.health + Target.shield and CanFlashQ3() then
			DrawText3D("Overkill :"..math.round(damages - Target.health + Target.shield).."", Target.x, Target.y, Target.z, 30, ARGB(255, 255, 255, 255), 0);
		else
			if Param.Enable and Param.QE then
				DrawText3D("kill in :"..math.round(Target.health - damages).."", Target.x, Target.y, Target.z, 30, ARGB(255, 255, 255, 255), 0);
			end
		end
	end
	if Target ~= nil then
		if Q == true then
			DrawText3D("[Q]",myHero.x-150, myHero.y-100, myHero.z+100, 20, ARGB(255, 39, 174, 96));
		else
			DrawText3D("[Q]",myHero.x-150, myHero.y-100, myHero.z+100, 20, ARGB(255, 192, 57, 43));
		end
		if Q3 == true then
			DrawText3D("[Q3]",myHero.x-100, myHero.y-100, myHero.z+100, 20, ARGB(255, 39, 174, 96));
		else
			DrawText3D("[Q3]",myHero.x-100, myHero.y-100, myHero.z+100, 20, ARGB(255, 192, 57, 43));
		end
		if E == true then
			DrawText3D("[E]",myHero.x-50, myHero.y-100, myHero.z+100, 20, ARGB(255, 39, 174, 96));
		else
			DrawText3D("[E]",myHero.x-50, myHero.y-100, myHero.z+100, 20, ARGB(255, 192, 57, 43));
		end
		if R == true then
			DrawText3D("[R]",myHero.x, myHero.y-100, myHero.z+100, 20, ARGB(255, 39, 174, 96));
		else
			DrawText3D("[R]",myHero.x, myHero.y-100, myHero.z+100, 20, ARGB(255, 192, 57, 43));
		end
		if FlashReady == true then
			DrawText3D("[F]",myHero.x+50, myHero.y-100, myHero.z+100, 20, ARGB(255, 39, 174, 96));
		else
			DrawText3D("[F]",myHero.x+50, myHero.y-100, myHero.z+100, 20, ARGB(255, 192, 57, 43));
		end
	end
end

function Menu()
	Param = scriptConfig("BeyBlade Settings", "BeyBlade");

	Param:addParam("Enable", "Enable BeyBlade :", SCRIPT_PARAM_ONOFF, true);
	Param:addParam("n1", "", SCRIPT_PARAM_INFO, "");
	Param:addParam("QE", "Use BeyBlade with can kill with Q3 + E :", SCRIPT_PARAM_ONOFF, true);
	Param:addParam("n2", "And also 1 enemy in range.", SCRIPT_PARAM_INFO, "");
	Param:addParam("n3", "", SCRIPT_PARAM_INFO, "");
	Param:addParam("Auto", "Use BeyBlade is there is X enemy to hit :", SCRIPT_PARAM_ONOFF, true);
	Param:addParam("HowMuch", "Set a number for X enemy :", SCRIPT_PARAM_SLICE, 3, 0, 5);
	Param:addParam("n4", "", SCRIPT_PARAM_INFO, "");
	Param:addParam("key", "Key to toggle on everytime :", SCRIPT_PARAM_ONKEYTOGGLE, false, string.byte("T"));
end

function EnemyInRange()
	local n = 0;
	for _, unit in pairs(GetEnemyHeroes()) do
		if ValidTarget(unit) and not unit.dead and unit.visible and unit.health > 0 and GetDistanceSqr(unit) < 2250000 then
			n = n + 1;
		end
	end
	return n
end

function CanHit(nbr)
	local n = 0;
	for _, unit in pairs(GetEnemyHeroes()) do
		if ValidTarget(unit) and not unit.dead and unit.visible and unit.health > 0 and GetDistanceSqr(Target, unit) < 105625 then
			n = n + 1;
		end
	end
	if n >= nbr then
		return true
	else
		return false
	end
end
